# D8.3 — Purchase Orders Module

Status: stable  
Owner: Lead Architect  
Last verified against: (run: `git rev-parse --short HEAD`) — 2025-02-17  
Related documents: D2, D3, D8.1, D8.2  

---

## 1. Scope

Documenta el mòdul Purchase Orders (PO):

- purchase_orders
- po_shipments
- po_amazon_readiness
- order_items (si aplicable)
- dependències amb Projects i Suppliers

Inclou model, integritat referencial, RLS i comportament de cascada.

---

## 2. Core Table — purchase_orders

Tenant-scoped table.

- org_id uuid NOT NULL
- FK → orgs(id)
- FK → projects(id)
- FK → suppliers(id) (si definit)
- RLS enabled
- Policies amb is_org_member(org_id)

Representa comandes formals a proveïdors.

---

## 3. Related Tables

### po_shipments
- FK a purchase_orders(id)
- org_id enforced
- ON DELETE behavior dependent on FK

### po_amazon_readiness
- FK a purchase_orders(id)
- org_id enforced

### order_items (si existeix)
- FK a purchase_orders(id)
- FK a product_variants(id)
- org_id enforced

---

## 4. Multi-tenant Enforcement

Totes les taules relacionades han de tenir org_id.

Policies:
- SELECT → is_org_member(org_id)
- Mutations → WITH CHECK is_org_member(org_id)

---

## 5. Referential Integrity

Confirmar:

- FKs reals a purchase_orders(id)
- ON DELETE behavior
- No possibilitat d'orfes

---

## 6. Data Flow

Projects → Suppliers → Quotes → POs → Shipments → Amazon readiness

PO és node financer i logístic central.

---

## 7. Security Model

Cap PO pot ser visible fora del seu org.

---

## 8. Verification

- No org_id NULL
- No shipments sense PO
- No readiness sense PO
- RLS enabled

---

## 8.1 AS-IS Repo Gaps (Important)

The following table is referenced by S1.2 migrations (org_id backfill / RLS),
but its CREATE TABLE definition and FK constraints are not present in this repository snapshot:

- order_items

Notes:
- In this repo, S1.2 backfills order_items via order_id → orders.org_id, suggesting it is logically tied to Orders,
  not necessarily to Purchase Orders.

Implication:
- org_id and RLS may be enforced if the table exists in the target database,
  but its exact relational contract (FKs, ON DELETE) cannot be audited from this repo alone.

Action:
- Add missing CREATE TABLE migration(s) (or import the historical definition) to restore full auditability,
  and document the correct ownership (Orders vs POs) once confirmed.

---

## 9. Change Policy

S'actualitza si:
- Es modifiquen FKs
- Es creen noves dependències
- Es modifica contracte RLS

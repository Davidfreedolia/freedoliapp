# D8.2 — Suppliers Module

Status: stable  
Owner: Lead Architect  
Last verified against: (run: `git rev-parse --short HEAD`) — 2025-02-17  
Related documents: D2, D3, D8.1  

---

## 1. Scope

Documenta el mòdul Suppliers i les seves dependències:

- suppliers
- supplier_quotes
- supplier_sample_requests
- supplier_price_estimates
- supplier_quote_price_breaks

Inclou model de dades, contracte multi-tenant i integritat referencial.

---

## 2. Core Table — suppliers

Tenant-scoped table.

- org_id uuid NOT NULL
- FK → orgs(id)
- RLS enabled
- Policies basades en is_org_member(org_id)

Representa entitats proveïdores associades a projectes.

---

## 3. Related Tables

### supplier_quotes
- FK a suppliers(id)
- FK a projects(id)
- org_id enforced
- ON DELETE behavior dependent on FK definition

### supplier_sample_requests
- FK a supplier_quotes(id)
- FK a projects(id)
- org_id enforced

### supplier_price_estimates
- FK a projects(id)
- FK a suppliers(id)

### supplier_quote_price_breaks
- FK a supplier_quotes(id)

---

## 4. Multi-tenant Enforcement

Totes les taules relacionades tenen org_id.

Policies:
- SELECT → is_org_member(org_id)
- Mutations → WITH CHECK is_org_member(org_id)

---

## 5. Data Flow

Projects → Suppliers → Quotes → Samples → POs

Suppliers és node central del flux de procurement.

---

## 6. Referential Integrity

Confirmar:

- FKs reals a suppliers(id)
- FKs reals a projects(id)
- ON DELETE behavior (CASCADE o RESTRICT)

No s'assumeix integritat si no hi ha FK explícita en migrations.

---

## 7. Security Model

Cap proveïdor pot ser visible fora del seu org.

Cross-tenant leakage impossible si RLS està actiu.

---

## 8. Verification

- No org_id NULL
- No quotes sense supplier
- No quotes sense project
- RLS enabled

---

## 8.1 AS-IS Repo Gaps (Important)

The following table is referenced by S1.2 migrations (org_id backfill / RLS),
but its CREATE TABLE definition and FK constraints are not present in this repository snapshot:

- supplier_quote_price_breaks

Implication:
- org_id and RLS may be enforced if the table exists in the target database,
  but referential integrity cannot be audited from this repo alone.

Also note:
- supplier_price_estimates is project-scoped in this repo (project_id FK exists),
  but no supplier_id FK is defined in the current schema snapshot.
  Treat it as "project-level estimates" unless schema evolves.

Action:
- Add missing CREATE TABLE migration(s) (or import the historical definition) to restore full auditability.

---

## 9. Change Policy

S'actualitza si:
- Es modifiquen FKs
- Es creen noves taules dependents
- Es modifica contracte org/RLS

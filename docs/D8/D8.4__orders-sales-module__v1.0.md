# D8.4 — Orders & Sales Module

Status: stable  
Owner: Lead Architect  
Last verified against: (run: `git rev-parse --short HEAD`) — 2025-02-17  
Related documents: D2, D3, D8.3  

---

## 1. Scope

Documenta el mòdul Orders & Sales:

- orders
- order_items
- sales
- inventory_movements (si aplicable)

Inclou model de dades, integritat referencial, org enforcement i relació amb finances.

---

## 2. Core Table — orders

Tenant-scoped table.

- org_id uuid NOT NULL
- FK → orgs(id)
- RLS enabled
- Policies basades en is_org_member(org_id)

Representa comandes de venda (no purchase orders).

---

## 3. order_items

- FK a orders(id)
- FK a product_variants(id) (si definit)
- org_id enforced
- ON DELETE behavior dependent on FK definition

---

## 4. sales

- Pot representar línies consolidades o dades de marketplace
- org_id enforced
- Relació amb orders segons esquema

---

## 5. Multi-tenant Enforcement

Totes les taules han de tenir org_id.

Policies:
- SELECT → is_org_member(org_id)
- Mutations → WITH CHECK is_org_member(org_id)

---

## 6. Referential Integrity

Confirmar:

- FKs reals a orders(id)
- FKs reals a product_variants(id)
- ON DELETE behavior
- No possibilitat d'orfes

---

## 7. Financial Impact

Orders & Sales poden impactar:

- incomes
- payments
- profitability
- inventory

Aquest impacte ha d'estar alineat amb el contracte multi-tenant.

---

## 8. Verification

- No org_id NULL
- No order_items sense order
- RLS enabled

---

## 8.1 AS-IS Repo Gaps (Critical)

The following tables are referenced by S1.2 migrations (org_id backfill / RLS),
but their CREATE TABLE definitions are not present in this repository snapshot:

- orders
- order_items
- sales
- inventory_movements

Implication:
- org_id and RLS may be enforced if these tables exist in the target database,
  but schema, foreign keys, ON DELETE behavior, and true ownership cannot be audited from this repo alone.

Observed hints from S1.2 backfill:
- order_items appears tied to orders via order_id → orders.org_id
- sales backfills via user_id → org_memberships (no orders linkage visible)
- inventory_movements backfills via warehouse_id → warehouses.org_id (no orders/PO linkage visible)

Action (mandatory for auditability):
- Add/import missing CREATE TABLE migrations for the above tables.
- After that, re-audit FKs and update this document to stable.

---

## 9. Change Policy

S'actualitza si:
- Es modifiquen FKs
- Es modifica model de sales
- Es canvia contracte org/RLS

# D2.1 — Migrations Log

Status: stable  
Owner: Lead Architect  
Last verified against: (run: `git rev-parse --short HEAD`) — 2025-02-17  
Related documents: D2, D3  

---

## Scope

Documenta les migracions estructurals que defineixen el model actual de dades i el contracte multi-tenant.

No substitueix les migracions SQL.  
Actua com a mapa auditable humà.

---

# S1 — Multi-tenant Consolidation Phase

## S1.0 — orgs & memberships

- Crea `orgs`
- Crea `org_memberships`
- Defineix `is_org_member(check_org uuid)`

Estableix el tenant boundary formal.

---

## S1.1 — Core org_id + RLS enforcement

- Afegeix `org_id` a taules core:
  - projects
  - suppliers
  - supplier_quotes
  - purchase_orders
  - supplier_sample_requests
  - company_settings
- Backfill determinista
- Enforce NOT NULL
- FK cap a `orgs`
- RLS org-based
- Defineix `is_org_owner_or_admin(check_org uuid)`

---

## S1.2 — org_id expansion

Afegeix `org_id` + backfill a múltiples taules operatives:

expenses, incomes, tasks, documents, inventory,
product_variants, project_viability,
gtin_assignments, health_runs, etc.

Marca el pas de user-tenancy a org-tenancy.

---

## S1.3 — Variant marketplace RLS

Aplica contracte org RLS a:
- variant_marketplace_asins

---

## S1.4 — Product variants RLS

Aplica contracte org RLS a:
- product_variants

---

## S1.5 — Project viability RLS

Aplica contracte org RLS a:
- project_viability

---

## S1.5.1 — Enforce NOT NULL viability

Completa enforcement estructural.

---

## S1.6 — GTIN assignments RLS

Aplica contracte org RLS a:
- gtin_assignments

---

## S1.7 — health_runs consolidation

- Afegeix `org_id`
- Backfill via project
- Delete orphans
- Enforce NOT NULL
- RLS org policies

Estableix precedent oficial de:
backfill determinista + eliminació d'orfes + enforcement.

---

## Verification Checklist

- No org_id NULL en taules TENANT
- No orphans
- RLS activat
- Policies existents

---

## Change Policy

Qualsevol nova migració que afecti:

- org_id
- RLS
- contracte multi-tenant

Ha de ser registrada aquí.

---

# Post-S1 — Auditability & RLS Hardening

- 20260223103000_fix_rls_restore_tables_canonical.sql  
  Canonicalizes RLS policies (org-based) for restored tables:
  orders, order_items, sales, inventory_movements,
  project_viability, project_phases, project_marketplaces, project_tasks,
  supplier_quote_price_breaks.
